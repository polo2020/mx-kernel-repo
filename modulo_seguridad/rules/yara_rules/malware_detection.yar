/*
 * üõ°Ô∏è SHIELD LINUX - Reglas YARA para Detecci√≥n de Malware
 * Reglas b√°sicas para detecci√≥n de patrones maliciosos
 */

rule Shellcode_Pattern {
    meta:
        description = "Detecta patrones de shellcode comunes"
        severity = "high"
    strings:
        $nop_sled = { 90 90 90 90 90 90 90 90 }
        $jmp_esp = { EB F8 }
        $call_pop = { E8 00 00 00 00 5? }
    condition:
        any of them
}

rule Base64_Exec {
    meta:
        description = "Detecta ejecuci√≥n de c√≥digo base64"
        severity = "high"
    strings:
        $powershell_b64 = /powershell\s+(-enc|-encodedcommand)/i
        $python_base64 = /base64\.b64decode\(/i
        $eval_base64 = /eval\s*\(\s*base64/i
    condition:
        any of them
}

rule Reverse_Shell {
    meta:
        description = "Detecta patrones de reverse shell"
        severity = "critical"
    strings:
        $bash_reverse = /bash\s+-i\s+>&\s+\/dev\/tcp\//i
        $nc_reverse = /nc\s+(-e|\/bin\/sh)/i
        $python_reverse = /socket\.connect.*subprocess/i
    condition:
        any of them
}

rule Crypto_Miner {
    meta:
        description = "Detecta patrones de miner√≠a de criptomonedas"
        severity = "high"
    strings:
        $stratum = /stratum\+tcp:\/\//i
        $xmrig = /xmrig|cryptonight|monero/i
        $pool = /pool\.[a-z]+:[0-9]+/i
    condition:
        any of them
}

rule SQL_Injection {
    meta:
        description = "Detecta patrones de SQL injection"
        severity = "high"
    strings:
        $union_select = /UNION\s+SELECT/i
        $or_1_equals_1 = /OR\s+1\s*=\s*1/i
        $drop_table = /DROP\s+TABLE/i
        $sleep = /SLEEP\s*\([0-9]+\)/i
    condition:
        any of them
}

rule XSS_Attack {
    meta:
        description = "Detecta patrones de XSS"
        severity = "medium"
    strings:
        $script_tag = /<script[^>]*>.*<\/script>/is
        $javascript_uri = /javascript:/i
        $onerror = /onerror\s*=/i
        $onload = /onload\s*=/i
    condition:
        any of them
}

rule Webshell_PHP {
    meta:
        description = "Detecta webshells PHP comunes"
        severity = "critical"
    strings:
        $c99 = /c99shell|c99madshell/i
        $r57 = /r57shell/i
        $eval_get = /\$_GET\[.*\]\s*\)/i
        $shell_exec = /shell_exec\s*\(/i
    condition:
        any of them
}

rule Meterpreter {
    meta:
        description = "Detecta patrones de Meterpreter"
        severity = "critical"
    strings:
        $meterpreter = /meterpreter/i
        $payload = /payload\.php|shell\.php/i
        $metsvc = /metsvc\.exe/i
    condition:
        any of them
}
