# ğŸ›¡ï¸ SHIELD LINUX - Makefile para MÃ³dulo del Kernel
# CompilaciÃ³n del mÃ³dulo de seguridad

KERNEL_VERSION := $(shell uname -r)
KERNEL_DIR := /lib/modules/$(KERNEL_VERSION)/build
PWD := $(shell pwd)

# Nombre del mÃ³dulo
MODULE_NAME := security_module

# Archivos fuente
obj-m := $(MODULE_NAME).o
$(MODULE_NAME)-objs := security_module.o countermeasures.o detection.o

# Flags de compilaciÃ³n
ccflags-y := -DDEBUG -O2 -Wall -Wextra

# Objetivos de compilaciÃ³n
all: modules clean

modules:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  ğŸ›¡ï¸  SHIELD LINUX - Compilando MÃ³dulo del Kernel  â•‘"
	@echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
	@echo "â•‘  VersiÃ³n del Kernel: $(KERNEL_VERSION)"
	@echo "â•‘  Directorio: $(KERNEL_DIR)"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	$(MAKE) -C $(KERNEL_DIR) M=$(PWD) modules

clean:
	$(MAKE) -C $(KERNEL_DIR) M=$(PWD) clean
	rm -f *.o *.ko *.mod.c *.mod *.order *.symvers .*.cmd
	rm -rf .tmp_versions

install:
	@echo "Instalando mÃ³dulo del kernel..."
	sudo cp $(MODULE_NAME).ko /lib/modules/$(KERNEL_VERSION)/kernel/security/
	sudo depmod -a
	sudo modprobe $(MODULE_NAME)
	@echo "âœ… MÃ³dulo instalado y cargado"

uninstall:
	@echo "Desinstalando mÃ³dulo del kernel..."
	sudo rmmod $(MODULE_NAME) 2>/dev/null || true
	sudo rm -f /lib/modules/$(KERNEL_VERSION)/kernel/security/$(MODULE_NAME).ko
	sudo depmod -a
	@echo "âœ… MÃ³dulo desinstalado"

load:
	sudo insmod $(MODULE_NAME).ko
	@echo "âœ… MÃ³dulo cargado"

unload:
	sudo rmmod $(MODULE_NAME)
	@echo "âœ… MÃ³dulo descargado"

status:
	@echo "Estado del mÃ³dulo:"
	lsmod | grep $(MODULE_NAME) || echo "MÃ³dulo no cargado"
	dmesg | grep -i shield | tail -20

test:
	@echo "Ejecutando pruebas bÃ¡sicas..."
	@echo "1. Verificando dependencias..."
	@which insmod >/dev/null && echo "   âœ“ insmod disponible" || echo "   âœ— insmod no encontrado"
	@which rmmod >/dev/null && echo "   âœ“ rmmod disponible" || echo "   âœ— rmmod no encontrado"
	@which dmesg >/dev/null && echo "   âœ“ dmesg disponible" || echo "   âœ— dmesg no encontrado"
	@echo "2. Verificando headers del kernel..."
	@test -d $(KERNEL_DIR) && echo "   âœ“ Headers encontrados" || echo "   âœ— Headers no encontrados"
	@echo "3. Verificando configuraciÃ³n del kernel..."
	@test -f /boot/config-$(KERNEL_VERSION) && echo "   âœ“ Config encontrada" || echo "   âœ— Config no encontrada"

help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  ğŸ›¡ï¸  SHIELD LINUX - Makefile Help                 â•‘"
	@echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
	@echo "â•‘  make all       - Compilar mÃ³dulo                 â•‘"
	@echo "â•‘  make clean     - Limpiar archivos                â•‘"
	@echo "â•‘  make install   - Instalar y cargar mÃ³dulo        â•‘"
	@echo "â•‘  make uninstall - Desinstalar mÃ³dulo              â•‘"
	@echo "â•‘  make load      - Cargar mÃ³dulo                   â•‘"
	@echo "â•‘  make unload    - Descargar mÃ³dulo                â•‘"
	@echo "â•‘  make status    - Ver estado                      â•‘"
	@echo "â•‘  make test      - Ejecutar pruebas                â•‘"
	@echo "â•‘  make help      - Mostrar esta ayuda              â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

.PHONY: all modules clean install uninstall load unload status test help
